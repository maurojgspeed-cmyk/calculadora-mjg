<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MJG Voice Systems</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="MJG Voice">
    <meta name="theme-color" content="#0a0e14">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <style>
        :root { --cyan: #00d4ff; --red: #ff4757; --dark: #0a0e14; --panel: #111821; }
        body { 
            background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; 
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        .brand { padding: 10px; text-align: center; letter-spacing: 4px; color: var(--cyan); font-size: 0.8rem; border-bottom: 1px solid #222; }
        #history { flex: 1; padding: 15px; overflow-y: auto; color: #555; font-family: monospace; text-align: right; font-size: 1rem; }
        .display { padding: 10px 20px; background: rgba(255,255,255,0.02); text-align: right; }
        #transcript { color: var(--cyan); font-size: 0.9rem; min-height: 1.2rem; margin-bottom: 5px; }
        #result { font-size: 4.5rem; font-weight: bold; margin: 0; line-height: 1; }
        .voice-area { padding: 15px; display: flex; justify-content: center; background: var(--panel); }
        #micBtn { 
            background: transparent; border: 2px solid var(--cyan); color: var(--cyan); 
            padding: 14px; border-radius: 50px; cursor: pointer; font-weight: bold; width: 85%;
        }
        #micBtn.active { background: var(--red); border-color: var(--red); color: white; box-shadow: 0 0 20px var(--red); }
        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #222; border-top: 1px solid #333; }
        button.key { background: var(--dark); border: none; color: white; padding: 18px; font-size: 1.6rem; cursor: pointer; }
        button.op { color: var(--cyan); font-weight: bold; }
        button.eq { background: var(--cyan); color: var(--dark); font-weight: bold; }
        button.del { color: var(--red); font-size: 1.1rem; }
    </style>
</head>
<body>

    <div class="brand">MJG VOICE SYSTEMS</div>
    <div id="history"></div>
    <div class="display">
        <div id="transcript">modo híbrido listo</div>
        <div id="result">0</div>
    </div>
    <div class="voice-area">
        <button id="micBtn" onclick="toggleListen()">Presionar para hablar</button>
    </div>
    <div class="keypad">
        <button class="key del" onclick="clearAll()">AC</button>
        <button class="key op" onclick="addChar('/')">÷</button>
        <button class="key op" onclick="addChar('*')">×</button>
        <button class="key del" onclick="deleteLast()">⌫</button>
        <button class="key" onclick="addChar('7')">7</button>
        <button class="key" onclick="addChar('8')">8</button>
        <button class="key" onclick="addChar('9')">9</button>
        <button class="key op" onclick="addChar('-')">-</button>
        <button class="key" onclick="addChar('4')">4</button>
        <button class="key" onclick="addChar('5')">5</button>
        <button class="key" onclick="addChar('6')">6</button>
        <button class="key op" onclick="addChar('+')">+</button>
        <button class="key" onclick="addChar('1')">1</button>
        <button class="key" onclick="addChar('2')">2</button>
        <button class="key" onclick="addChar('3')">3</button>
        <button class="key eq" style="grid-row: span 2;" onclick="calculate(true)">=</button>
        <button class="key" style="grid-column: span 2;" onclick="addChar('0')">0</button>
        <button class="key" onclick="addChar('.')">.</button>
    </div>

    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'es-AR';
        let isListening = false, currentInput = "", acumulado = 0;

        const resEl = document.getElementById('result'), transEl = document.getElementById('transcript');
        const histEl = document.getElementById('history'), micBtn = document.getElementById('micBtn');

        function toggleListen() { if (!isListening) recognition.start(); else recognition.stop(); }
        recognition.onstart = () => { isListening = true; micBtn.classList.add('active'); micBtn.innerText = "Escuchando..."; };
        recognition.onend = () => { isListening = false; micBtn.classList.remove('active'); micBtn.innerText = "Presionar para hablar"; };
        recognition.onresult = (event) => { const text = event.results[0][0].transcript.toLowerCase(); transEl.innerText = text; processVoice(text); };

        function processVoice(text) {
            let clean = text.replace(/ coma | con | punto /g, '.').replace(/,/g, '.')
                .replace(/más/g, '+').replace(/menos/g, '-').replace(/por|x/g, '*').replace(/dividido|entre/g, '/')
                .replace(/[^0-9\+\-\*\/\.]/g, '');
            if (acumulado !== 0 && !/^[\+\-\*\/]/.test(clean)) clean = "+" + clean;
            currentInput = acumulado !== 0 ? acumulado + clean : clean;
            calculate(true);
        }

        function addChar(char) {
            if (resEl.innerText === "0" && !isNaN(char)) currentInput = char;
            else currentInput = currentInput.toString() + char;
            resEl.innerText = currentInput;
        }

        function deleteLast() { currentInput = currentInput.toString().slice(0, -1); resEl.innerText = currentInput || "0"; }

        function calculate(speakVal = false) {
            try {
                let formula = currentInput || "0";
                if (formula.endsWith('.') || /[\+\-\*\/]$/.test(formula)) return;
                
                // MEJORA DE SEGURIDAD: Usando Function en lugar de eval
                const total = new Function('return ' + formula)();
                
                if (total !== undefined && !isNaN(total)) {
                    const formatted = Number.isInteger(total) ? total : parseFloat(total.toFixed(2));
                    const item = document.createElement('div');
                    item.innerText = formula + " = " + formatted;
                    histEl.appendChild(item);
                    histEl.scrollTop = histEl.scrollHeight;
                    acumulado = formatted; resEl.innerText = formatted; currentInput = acumulado.toString();
                    if (speakVal) speak(formatted);
                }
            } catch (e) { console.log("Error en el cálculo"); }
        }

        function clearAll() { acumulado = 0; currentInput = ""; resEl.innerText = "0"; histEl.innerHTML = ""; window.speechSynthesis.cancel(); }
        
        // MEJORA DE IDIOMA: Seteado a Argentina
        function speak(val) { 
            const u = new SpeechSynthesisUtterance(val); 
            u.lang = 'es-AR'; 
            window.speechSynthesis.speak(u); 
        }
    </script>
</body>
</html>