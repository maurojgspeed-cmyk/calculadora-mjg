<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MJG Voice Systems</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root { --cyan: #00d4ff; --red: #ff4757; --dark: #0a0e14; --panel: #111821; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body { 
            background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; height: 100vh; width: 100vw; overflow: hidden;
            position: fixed;
        }

        .header { 
            height: 50px; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; border-bottom: 1px solid #222; flex-shrink: 0; 
        }
        .brand { letter-spacing: 2px; color: var(--cyan); font-size: 0.7rem; font-weight: bold; }
        
        /* BotÃ³n de Imagen */
        .img-upload-btn {
            background: #222; color: var(--cyan); border: 1px solid var(--cyan);
            padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer;
        }

        #history { flex: 1; padding: 10px; overflow-y: auto; color: #555; font-family: monospace; text-align: right; font-size: 0.9rem; }
        
        /* Contenedor de imagen previa */
        #previewContainer { text-align: center; padding: 5px; display: none; }
        #previewImg { max-height: 80px; border-radius: 5px; border: 1px solid #444; }

        .display { padding: 15px 20px; background: rgba(255,255,255,0.02); text-align: right; flex-shrink: 0; }
        #transcript { color: var(--cyan); font-size: 0.8rem; min-height: 1.2rem; margin-bottom: 5px; opacity: 0.6; font-style: italic; }
        
        #result { 
            font-size: 4.5rem; font-weight: bold; line-height: 1; 
            overflow-x: auto; white-space: nowrap; scrollbar-width: none;
            text-align: right;
        }
        #result::-webkit-scrollbar { display: none; }

        .voice-area { padding: 12px; background: var(--panel); display: flex; justify-content: center; flex-shrink: 0; }
        #micBtn { 
            background: transparent; border: 2px solid var(--cyan); color: var(--cyan); 
            padding: 14px; border-radius: 50px; font-weight: bold; width: 90%; transition: 0.3s;
        }
        #micBtn.active { background: var(--red); border-color: var(--red); color: white; box-shadow: 0 0 15px var(--red); }
        
        .keypad { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            background: #222; gap: 1px; border-top: 1px solid #333;
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        button.key { background: var(--dark); border: none; color: white; height: clamp(60px, 10vh, 85px); font-size: 1.6rem; cursor: pointer; }
        button.key:active { background: #1a2430; }
        button.op { color: var(--cyan); font-weight: bold; }
        button.eq { background: var(--cyan) !important; color: var(--dark); font-weight: bold; }
        button.del { color: var(--red); font-size: 1.1rem; }

        @media screen and (orientation: landscape) {
            body { flex-direction: row; flex-wrap: wrap; }
            .header { width: 100%; }
            .keypad { grid-template-columns: repeat(6, 1fr); width: 60%; height: calc(100% - 50px); }
            #history, .display { width: 40%; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">MJG VOICE SYSTEMS</div>
        <label class="img-upload-btn">
            ðŸ“· SUBIR IMAGEN
            <input type="file" accept="image/*" style="display:none" onchange="handleImage(this)">
        </label>
    </div>

    <div id="history"></div>
    
    <div id="previewContainer">
        <img id="previewImg" src="">
    </div>

    <div class="display">
        <div id="transcript">esperando voz...</div>
        <div id="result">0</div>
    </div>

    <div class="voice-area">
        <button id="micBtn" onclick="toggleListen()">Presionar para hablar</button>
    </div>

    <div class="keypad">
        <button class="key del" onclick="clearAll()">AC</button>
        <button class="key op" onclick="addChar('/')">Ã·</button>
        <button class="key op" onclick="addChar('*')">Ã—</button>
        <button class="key del" onclick="deleteLast()">âŒ«</button>
        <button class="key" onclick="addChar('7')">7</button>
        <button class="key" onclick="addChar('8')">8</button>
        <button class="key" onclick="addChar('9')">9</button>
        <button class="key op" onclick="addChar('-')">-</button>
        <button class="key" onclick="addChar('4')">4</button>
        <button class="key" onclick="addChar('5')">5</button>
        <button class="key" onclick="addChar('6')">6</button>
        <button class="key op" onclick="addChar('+')">+</button>
        <button class="key" onclick="addChar('1')">1</button>
        <button class="key" onclick="addChar('2')">2</button>
        <button class="key" onclick="addChar('3')">3</button>
        <button class="key eq" style="grid-row: span 2;" onclick="calculate(true)">=</button>
        <button class="key" style="grid-column: span 2;" onclick="addChar('0')">0</button>
        <button class="key" onclick="addChar('.')">.</button>
    </div>

    <script>
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'es-AR';
        let isListening = false, currentInput = "", acumulado = 0;

        const resEl = document.getElementById('result'), transEl = document.getElementById('transcript');
        const histEl = document.getElementById('history'), micBtn = document.getElementById('micBtn');

        // FunciÃ³n para manejar la imagen
        function handleImage(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('previewContainer').style.display = 'block';
                    const item = document.createElement('div');
                    item.innerHTML = ðŸ–¼ï¸ Imagen cargada: ${file.name};
                    histEl.appendChild(item);
                }
                reader.readAsDataURL(file);
            }
        }

        function toggleListen() { isListening ? recognition.stop() : recognition.start(); }
        recognition.onstart = () => { isListening = true; micBtn.classList.add('active'); micBtn.innerText = "Escuchando..."; };
        recognition.onend = () => { isListening = false; micBtn.classList.remove('active'); micBtn.innerText = "Presionar para hablar"; };
        
        recognition.onresult = (event) => { 
            const text = event.results[0][0].transcript.toLowerCase(); 
            transEl.innerText = text; 
            processVoice(text); 
        };

        function processVoice(text) {
            let raw = text
                .replace(/ dividido por | dividido | dividir | dividÃ­ /g, '/')
                .replace(/ sobre | entre /g, '/')
                .replace(/ por | x | multiplicado por /g, '*')
                .replace(/ mÃ¡s | suma /g, '+')
                .replace(/ menos | resta /g, '-')
                .replace(/ coma | con | punto /g, '.')
                .replace(/,/g, '.')
                .replace(/\s+/g, '');

            if (acumulado !== 0) {
                if (raw.startsWith('-') || raw.startsWith('/')) {
                    // Mantiene el signo
                } else if (!isNaN(raw.charAt(0))) {
                    raw = "+" + raw;
                }
            }

            let clean = raw.replace(/[^0-9\+\-\*\/\.]/g, '');
            currentInput = acumulado !== 0 ? acumulado.toString() + clean : clean;
            calculate(true);
        }

        function addChar(char) {
            if (resEl.innerText === "0" && !isNaN(char)) currentInput = char;
            else currentInput = currentInput.toString() + char;
            updateDisplay();
        }

        function updateDisplay() {
            resEl.innerText = currentInput || "0";
            setTimeout(() => { resEl.scrollLeft = resEl.scrollWidth; }, 50);
        }

        function calculate(speakVal = false) {
            try {
                let formula = currentInput || "0";
                if (/[\+\-\*\/]$/.test(formula)) return;
                const total = eval(formula); 
                if (total !== undefined && !isNaN(total)) {
                    const formatted = Number.isInteger(total) ? total : parseFloat(total.toFixed(2));
                    const item = document.createElement('div');
                    item.innerText = formula + " = " + formatted;
                    histEl.appendChild(item);
                    histEl.scrollTop = histEl.scrollHeight;
                    acumulado = formatted; 
                    currentInput = acumulado.toString();
                    updateDisplay();
                    if (speakVal) speak(formatted);
                }
            } catch (e) { transEl.innerText = "Error en cuenta"; }
        }

        function clearAll() { 
            acumulado = 0; currentInput = ""; resEl.innerText = "0"; 
            histEl.innerHTML = ""; transEl.innerText = "esperando voz...";
            document.getElementById('previewContainer').style.display = 'none';
            window.speechSynthesis.cancel(); 
        }

        function deleteLast() { currentInput = currentInput.toString().slice(0, -1); updateDisplay(); }
        function speak(val) { const u = new SpeechSynthesisUtterance(val); u.lang = 'es-AR'; window.speechSynthesis.speak(u); }
    </script>
</body>
</html>