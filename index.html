<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MJG Voice Systems</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root { --cyan: #00d4ff; --red: #ff4757; --dark: #0a0e14; --panel: #111821; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }

        body { 
            background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; height: 100vh; width: 100vw; overflow: hidden;
            position: fixed;
        }

        .brand { height: 40px; display: flex; align-items: center; justify-content: center; letter-spacing: 4px; color: var(--cyan); font-size: 0.7rem; border-bottom: 1px solid #222; flex-shrink: 0; }
        
        #history { flex: 1; padding: 10px; overflow-y: auto; color: #555; font-family: monospace; text-align: right; font-size: 0.9rem; }
        
        .display { padding: 15px 20px; background: rgba(255,255,255,0.02); text-align: right; flex-shrink: 0; }
        #transcript { color: var(--cyan); font-size: 0.8rem; min-height: 1.2rem; margin-bottom: 5px; opacity: 0.6; font-style: italic; }
        
        #result { 
            font-size: 4.5rem; font-weight: bold; line-height: 1; 
            overflow-x: auto; white-space: nowrap; scrollbar-width: none;
            direction: ltr; text-align: right;
        }
        #result::-webkit-scrollbar { display: none; }

        .voice-area { padding: 12px; background: var(--panel); display: flex; justify-content: center; flex-shrink: 0; }
        #micBtn { 
            background: transparent; border: 2px solid var(--cyan); color: var(--cyan); 
            padding: 14px; border-radius: 50px; font-weight: bold; width: 90%; transition: 0.3s;
        }
        #micBtn.active { background: var(--red); border-color: var(--red); color: white; box-shadow: 0 0 15px var(--red); }
        
        .keypad { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            background: #222; gap: 1px; border-top: 1px solid #333;
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        button.key { background: var(--dark); border: none; color: white; height: clamp(60px, 10vh, 80px); font-size: 1.6rem; cursor: pointer; }
        button.key:active { background: #1a2430; }
        button.op { color: var(--cyan); font-weight: bold; }
        button.eq { background: var(--cyan) !important; color: var(--dark); font-weight: bold; }
        button.del { color: var(--red); font-size: 1.1rem; }
    </style>
</head>
<body>

    <div class="brand">MJG VOICE SYSTEMS</div>
    <div id="history"></div>
    <div class="display">
        <div id="transcript">esperando voz...</div>
        <div id="result">0</div>
    </div>
    <div class="voice-area">
        <button id="micBtn" onclick="toggleListen()">Presionar para hablar</button>
    </div>
    <div class="keypad">
        <button class="key del" onclick="clearAll()">AC</button>
        <button class="key op" onclick="addChar('/')">÷</button>
        <button class="key op" onclick="addChar('*')">×</button>
        <button class="key del" onclick="deleteLast()">⌫</button>
        <button class="key" onclick="addChar('7')">7</button>
        <button class="key" onclick="addChar('8')">8</button>
        <button class="key" onclick="addChar('9')">9</button>
        <button class="key op" onclick="addChar('-')">-</button>
        <button class="key" onclick="addChar('4')">4</button>
        <button class="key" onclick="addChar('5')">5</button>
        <button class="key" onclick="addChar('6')">6</button>
        <button class="key op" onclick="addChar('+')">+</button>
        <button class="key" onclick="addChar('1')">1</button>
        <button class="key" onclick="addChar('2')">2</button>
        <button class="key" onclick="addChar('3')">3</button>
        <button class="key eq" style="grid-row: span 2;" onclick="calculate(true)">=</button>
        <button class="key" style="grid-column: span 2;" onclick="addChar('0')">0</button>
        <button class="key" onclick="addChar('.')">.</button>
    </div>

    <script>
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'es-AR';
        recognition.continuous = false;
        let isListening = false, currentInput = "", acumulado = 0;

        const resEl = document.getElementById('result'), transEl = document.getElementById('transcript');
        const histEl = document.getElementById('history'), micBtn = document.getElementById('micBtn');

        function toggleListen() { isListening ? recognition.stop() : recognition.start(); }
        
        recognition.onstart = () => { isListening = true; micBtn.classList.add('active'); micBtn.innerText = "Escuchando..."; };
        recognition.onend = () => { isListening = false; micBtn.classList.remove('active'); micBtn.innerText = "Presionar para hablar"; };
        
        recognition.onresult = (event) => { 
            const text = event.results[0][0].transcript.toLowerCase(); 
            transEl.innerText = text; 
            processVoice(text); 
        };

        function processVoice(text) {
            // Mapeo exhaustivo para evitar errores de interpretación
            let clean = text
                .replace(/ dividido por | dividido | dividir | sobre | entre /g, '/')
                .replace(/ menos | resta | quítale /g, '-')
                .replace(/ más | suma | agrégale /g, '+')
                .replace(/ por | x | multiplicado por /g, '*')
                .replace(/ coma | con | punto /g, '.')
                .replace(/,/g, '.');

            // Eliminar cualquier texto que no sea números o operadores
            clean = clean.replace(/[^0-9\+\-\*\/\.]/g, '');

            // REGLA DE ORO: Si hay un acumulado y lo primero que detectamos es un número 
            // (sin operador), forzamos una suma para no "pegar" los números.
            if (acumulado !== 0 && /^[0-9]/.test(clean)) {
                clean = "+" + clean;
            }

            currentInput = acumulado !== 0 ? acumulado + clean : clean;
            calculate(true);
        }

        function addChar(char) {
            if (resEl.innerText === "0" && !isNaN(char)) currentInput = char;
            else currentInput = currentInput.toString() + char;
            updateDisplay();
        }

        function updateDisplay() {
            resEl.innerText = currentInput || "0";
            // Forzar scroll a la derecha para ver siempre el total
            setTimeout(() => { resEl.scrollLeft = resEl.scrollWidth; }, 50);
        }

        function calculate(speakVal = false) {
            try {
                let formula = currentInput || "0";
                if (/[\+\-\*\/]$/.test(formula)) return;
                
                // Realizar el cálculo
                const total = new Function('return ' + formula)();
                
                if (total !== undefined && !isNaN(total)) {
                    const formatted = Number.isInteger(total) ? total : parseFloat(total.toFixed(2));
                    
                    const item = document.createElement('div');
                    item.innerText = formula + " = " + formatted;
                    histEl.appendChild(item);
                    histEl.scrollTop = histEl.scrollHeight;
                    
                    acumulado = formatted; 
                    currentInput = acumulado.toString();
                    updateDisplay();
                    
                    if (speakVal) speak(formatted);
                }
            } catch (e) { 
                transEl.innerText = "Error de interpretación";
            }
        }

        function clearAll() { 
            acumulado = 0; currentInput = ""; resEl.innerText = "0"; 
            histEl.innerHTML = ""; transEl.innerText = "memoria limpia";
            window.speechSynthesis.cancel(); 
        }

        function deleteLast() { 
            currentInput = currentInput.toString().slice(0, -1); 
            updateDisplay(); 
        }

        function speak(val) { 
            const u = new SpeechSynthesisUtterance(val); 
            u.lang = 'es-AR'; 
            window.speechSynthesis.speak(u); 
        }

        // Intentar bloquear orientación si está instalada
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('portrait').catch(() => {});
        }
    </script>
</body>
</html>